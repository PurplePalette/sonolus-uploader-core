/*
 * SweetPotato Server API
 *
 * Sonolusの基本APIを拡張する感じ。 ユーザー認証はFirebaseAuthorizationを通してやる。
 *
 * API version: 1.0
 * Generated by: OpenAPI Generator (https://openapi-generator.tech)
 */

package main

import (
	"log"
	"net/http"

	potato "github.com/PurplePalette/sonolus-uploader-core/potato"
	"github.com/PurplePalette/sonolus-uploader-core/utils/server"
	"github.com/rs/cors"
)

func main() {
	firebase := server.NewFirebaseClient()
	firestore := server.NewFirebaseFirestoreClient(firebase)
	auth := server.NewFirebaseAuthorizationClient(firebase)
	cache := potato.NewCacheService(firestore)
	if err := cache.InitCache(); err != nil {
		panic(err)
	}

	BackgroundsApiService := potato.NewBackgroundsApiService(firestore, cache)
	BackgroundsApiController := potato.NewBackgroundsApiController(BackgroundsApiService)

	EffectsApiService := potato.NewEffectsApiService(firestore, cache)
	EffectsApiController := potato.NewEffectsApiController(EffectsApiService)

	EnginesApiService := potato.NewEnginesApiService(firestore, cache)
	EnginesApiController := potato.NewEnginesApiController(EnginesApiService)

	InfoApiService := potato.NewInfoApiService(firestore, cache)
	InfoApiController := potato.NewInfoApiController(InfoApiService)

	LevelsApiService := potato.NewLevelsApiService(firestore, cache)
	LevelsApiController := potato.NewLevelsApiController(LevelsApiService)

	ParticlesApiService := potato.NewParticlesApiService(firestore, cache)
	ParticlesApiController := potato.NewParticlesApiController(ParticlesApiService)

	SkinsApiService := potato.NewSkinsApiService(firestore, cache)
	SkinsApiController := potato.NewSkinsApiController(SkinsApiService)

	TestsApiService := potato.NewTestsApiService(firestore, cache)
	TestsApiController := potato.NewTestsApiController(TestsApiService)

	UsersApiService := potato.NewUsersApiService(firestore, cache)
	UsersApiController := potato.NewUsersApiController(UsersApiService)

	listener := server.NewListener(firestore, cache)

	cols := []string{"backgrounds", "effects", "engines", "levels", "particles", "skins", "users"}
	for _, col := range cols {
		go listener.ListenFirestoreUpdate(col)
	}

	router := server.NewRouterWithInject(
		auth,
		BackgroundsApiController,
		EffectsApiController,
		EnginesApiController,
		InfoApiController,
		LevelsApiController,
		ParticlesApiController,
		SkinsApiController,
		TestsApiController,
		UsersApiController,
	)

	c := cors.New(cors.Options{
		AllowedOrigins:   []string{"http://localhost:3000"},
		AllowedMethods:   []string{"GET", "POST", "PATCH"},
		AllowedHeaders:   []string{"Authorization", "Content-Type"},
		AllowCredentials: true,
		// Enable Debugging for testing, consider disabling in production
		Debug: false,
	})
	corsSupportedHandler := c.Handler(router)

	log.Printf("Server started")
	log.Fatal(http.ListenAndServe(":8080", corsSupportedHandler))
}
